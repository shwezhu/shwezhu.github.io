<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring Security Authentication, Springå­¦ä¹ (äº”) - David&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="David" /><meta name="description" content="0. é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 â””â”€â”€ src â”œâ”€â”€ main â”‚ â”œâ”€â”€ java â”‚ â”‚ â””â”€â”€ david â”‚ â”‚ â””â”€â”€ zhu â”‚ â”‚ â”œâ”€â”€ SpringSecurityDemoApplication.java â”‚ â”‚ â”œâ”€â”€ WebController.java â”‚ â”‚ â””â”€â”€ WebSecurityConfig.java â”‚ â””â”€â”€ resources â”‚ â”œâ”€â”€ application.yaml" />






<meta name="generator" content="Hugo 0.123.7 with theme even" />


<link rel="canonical" href="https://davidzhu.xyz/post/java/backend/005-spring-security/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring Security Authentication, Springå­¦ä¹ (äº”)" />
<meta property="og:description" content="0. é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 â””â”€â”€ src â”œâ”€â”€ main â”‚ â”œâ”€â”€ java â”‚ â”‚ â””â”€â”€ david â”‚ â”‚ â””â”€â”€ zhu â”‚ â”‚ â”œâ”€â”€ SpringSecurityDemoApplication.java â”‚ â”‚ â”œâ”€â”€ WebController.java â”‚ â”‚ â””â”€â”€ WebSecurityConfig.java â”‚ â””â”€â”€ resources â”‚ â”œâ”€â”€ application.yaml" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://davidzhu.xyz/post/java/backend/005-spring-security/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-08-04T19:16:49+00:00" />
<meta property="article:modified_time" content="2023-08-04T19:16:49+00:00" />

<meta itemprop="name" content="Spring Security Authentication, Springå­¦ä¹ (äº”)">
<meta itemprop="description" content="0. é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 â””â”€â”€ src â”œâ”€â”€ main â”‚ â”œâ”€â”€ java â”‚ â”‚ â””â”€â”€ david â”‚ â”‚ â””â”€â”€ zhu â”‚ â”‚ â”œâ”€â”€ SpringSecurityDemoApplication.java â”‚ â”‚ â”œâ”€â”€ WebController.java â”‚ â”‚ â””â”€â”€ WebSecurityConfig.java â”‚ â””â”€â”€ resources â”‚ â”œâ”€â”€ application.yaml"><meta itemprop="datePublished" content="2023-08-04T19:16:49+00:00" />
<meta itemprop="dateModified" content="2023-08-04T19:16:49+00:00" />
<meta itemprop="wordCount" content="3123">
<meta itemprop="keywords" content="Java,Spring Boot," /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Spring Security Authentication, Springå­¦ä¹ (äº”)"/>
<meta name="twitter:description" content="0. é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 â””â”€â”€ src â”œâ”€â”€ main â”‚ â”œâ”€â”€ java â”‚ â”‚ â””â”€â”€ david â”‚ â”‚ â””â”€â”€ zhu â”‚ â”‚ â”œâ”€â”€ SpringSecurityDemoApplication.java â”‚ â”‚ â”œâ”€â”€ WebController.java â”‚ â”‚ â””â”€â”€ WebSecurityConfig.java â”‚ â””â”€â”€ resources â”‚ â”œâ”€â”€ application.yaml"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">David&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">David&#39;s Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring Security Authentication, Springå­¦ä¹ (äº”)</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-08-04 </span>
        <div class="post-category">
            <a href="/categories/java/"> Java </a>
            <a href="/categories/backend/"> Backend </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0-é¡¹ç›®ç»“æ„">0. é¡¹ç›®ç»“æ„</a></li>
        <li><a href="#1-åˆ›å»ºä¸€ä¸ªç®€å•çš„-spring-boot-é¡¹ç›®---controller-ç±»">1. åˆ›å»ºä¸€ä¸ªç®€å•çš„ spring boot é¡¹ç›® - <code>Controller</code> ç±»</a></li>
        <li><a href="#2-ä½¿ç”¨-spring-security-ä¿æŠ¤-web-application">2. ä½¿ç”¨ spring security ä¿æŠ¤ web application</a></li>
        <li><a href="#3-è‡ªå®šä¹‰-spring-security---websecurityconfig-ç±»">3. è‡ªå®šä¹‰ spring security - <code>WebSecurityConfig</code> ç±»</a></li>
        <li><a href="#4-single-sign-on-sso-å¯è·³è¿‡">4. Single sign-on (SSO) å¯è·³è¿‡</a></li>
        <li><a href="#5-è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯---authentication-object">5. è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ - <code>Authentication Object</code></a></li>
        <li><a href="#6-æŸ¥çœ‹-openid-ç”¨æˆ·é‚®ç®±">6. æŸ¥çœ‹ OpenID ç”¨æˆ·é‚®ç®±</a></li>
        <li><a href="#7-é€šè¿‡-debug-æŸ¥çœ‹-authentication-object">7. é€šè¿‡ debug æŸ¥çœ‹ <code>Authentication Object</code></a></li>
        <li><a href="#8-æ€»ç»“">8. æ€»ç»“</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="0-é¡¹ç›®ç»“æ„">0. é¡¹ç›®ç»“æ„</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â””â”€â”€ src
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ main
</span></span><span class="line"><span class="cl">    â”‚Â Â  â”œâ”€â”€ java
</span></span><span class="line"><span class="cl">    â”‚Â Â  â”‚Â Â  â””â”€â”€ david
</span></span><span class="line"><span class="cl">    â”‚Â Â  â”‚Â Â      â””â”€â”€ zhu
</span></span><span class="line"><span class="cl">    â”‚Â Â  â”‚Â Â          â”œâ”€â”€ SpringSecurityDemoApplication.java
</span></span><span class="line"><span class="cl">    â”‚Â Â  â”‚Â Â          â”œâ”€â”€ WebController.java
</span></span><span class="line"><span class="cl">    â”‚Â Â  â”‚Â Â          â””â”€â”€ WebSecurityConfig.java
</span></span><span class="line"><span class="cl">    â”‚Â Â  â””â”€â”€ resources
</span></span><span class="line"><span class="cl">    â”‚Â Â      â”œâ”€â”€ application.yaml
</span></span><span class="line"><span class="cl">    â”‚Â Â      â”œâ”€â”€ static
</span></span><span class="line"><span class="cl">    â”‚Â Â      â””â”€â”€ templates
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¾‹å­åœ°å€: <a href="https://github.com/shwezhu/springboot-learning/tree/master/spring-security-get-started-demo">https://github.com/shwezhu/springboot-learning/tree/master/spring-security-get-started-demo</a></p>
<h2 id="1-åˆ›å»ºä¸€ä¸ªç®€å•çš„-spring-boot-é¡¹ç›®---controller-ç±»">1. åˆ›å»ºä¸€ä¸ªç®€å•çš„ spring boot é¡¹ç›® - <code>Controller</code> ç±»</h2>
<p>åˆ›å»ºä¸€ä¸ª spring é¡¹ç›®æ€è·¯, é¦–å…ˆè¦æƒ³åˆ°åˆ›å»ºçš„ä¸€ä¸ªç±»æ˜¯ Controller, å› ä¸ºæˆ‘ä»¬è¦å¤„ç†ä¸åŒçš„ endpoints, æ¯”å¦‚å« <code>WebController.java</code>, åå­æ— æ‰€è°“, åªè¦åŠ ä¸Š <code>@Controller/@RestController</code> çš„ç±»éƒ½æ˜¯ Controller, ç„¶åè€ƒè™‘ä½ çš„è¿™ä¸ª Controller æ˜¯è¦è¿”å›ç®€å•çš„ json å¯¹è±¡è¿˜æ˜¯ web é¡µé¢, å‰è€…çš„è¯å°±é€‰æ‹© <code>@RestController</code> ä¿®é¥°ä½ çš„ Controller, è‡³äºè¿™ä¸¤ä¸ªæ³¨è§£çš„åŒºåˆ«, å¯ä»¥å‚è€ƒ: <a href="https://davidzhu.xyz/2023/07/29/Java/Backend/001-first-spring-boot-program/">Spring Booté¡¹ç›®åŠè¸©å‘æ€»ç»“ Springå­¦ä¹ (ä¸€)</a></p>
<p>åˆ›å»ºä¸€ä¸ªç®€å•çš„ spring boot é¡¹ç›®, ä¾èµ–åªé€‰æ‹© spring web, ä¹‹åæ…¢æ…¢æ·»åŠ å„ç§ä¾èµ–, åˆ›å»ºä¸€ä¸ªç®€å•çš„ Controller, å¦‚ä¸‹:</p>
<p><img src="/005-spring-security/1.png" alt="1"></p>
<p>ç”±äºæ²¡æœ‰ä½¿ç”¨ spring security, ç°åœ¨è¿™ä¸¤ä¸ª endpoints éƒ½å¯ä»¥é€šè¿‡ http://localhost:8080/private æˆ– http://localhost:8080 è®¿é—®,</p>
<h2 id="2-ä½¿ç”¨-spring-security-ä¿æŠ¤-web-application">2. ä½¿ç”¨ spring security ä¿æŠ¤ web application</h2>
<p>åœ¨é¡¹ç›®ä¸­æ·»åŠ  spring security ä¾èµ–, æ­¤ä¾‹ä½¿ç”¨çš„ gradle, å› æ­¤ç¼–è¾‘ <code>build.gradle</code>, æ·»åŠ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gradle" data-lang="gradle"><span class="line"><span class="cl"><span class="n">implementation</span> <span class="s1">&#39;org.springframework.boot:spring-boot-starter-security&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‹¥ä½ ç”¨çš„maven, å¯ä»¥ç¼–è¾‘ <code>pom.xml</code> è¿›è¡Œæ·»åŠ ä¾èµ–, æ·»åŠ å®Œå reload é…ç½®ç„¶åç›´æ¥è¿è¡Œé¡¹ç›®, æ­¤æ—¶ä¸¤ä¸ªendpoints, <code>/</code> å’Œ <code>/private</code> éƒ½é»˜è®¤å—åˆ°äº†ä¿æŠ¤, éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># -v, --verbose: Makes  the  fetching more verbose/talkative.</span>
</span></span><span class="line"><span class="cl">$ curl localhost:8080 -v
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&gt; GET / HTTP/1.1
</span></span><span class="line"><span class="cl">&gt; Host: localhost:8080
</span></span><span class="line"><span class="cl">&gt; Accept: */*
</span></span><span class="line"><span class="cl">&lt; HTTP/1.1 <span class="m">401</span> 
</span></span><span class="line"><span class="cl">&lt; Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>9342C2B61BCD3507B78E3602EC448A59<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»è¾“å‡ºå¯ä»¥çœ‹åˆ° http code: 401,</p>
<blockquote>
<p>401 Unauthorized is the status code to return when the client provides no credentials or invalid credentials.</p>
</blockquote>
<p>åªæ·»åŠ äº† spring security ä¾èµ–, ç„¶åè¿è¡Œé¡¹ç›®, æˆ‘ä»¬çš„é¡µé¢å°±è¢«ä¿æŠ¤, ä¸å¾—ä¸è¯´ spring é»˜é»˜åœ°åœ¨èƒŒåå¸®æˆ‘ä»¬åšäº†å¾ˆå¤š, ä¹‹æ‰€ä»¥éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®é‚£ä¸¤ä¸ª endpointsçš„åŸå› æ˜¯åœ¨ spring securityä¸­ <em>everything is secure by default</em>, ä½†æˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™äº›é…ç½®,</p>
<p>åœ¨è¿›è¡Œä¸‹ä¸€æ­¥çš„æ—¶å€™è¦æ³¨æ„, å³ä½¿æˆ‘ä»¬è¯•å›¾è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢æ¯”å¦‚ http://localhost:8080/foo , å¾—åˆ°çš„ä¾æ—§æ˜¯ 401 forbidden code, å³ä¼šç›´æ¥è·³å‡ºç™»å½•é¡µé¢, è€Œä¸æ˜¯å‘Šè¯‰ä½  404, é¡µé¢ä¸å­˜åœ¨, å³æ‰€æœ‰è®¿é—®æ­¤ç½‘å€çš„è¯·æ±‚éƒ½è¢« spring security æ‹¦æˆª, åªæœ‰ä½ æˆåŠŸç™»å½•, æ‰èƒ½è®¿é—®é¡µé¢, æ­¤æ—¶å› ä¸ºé¡µé¢ä¸å­˜åœ¨, ä½ å¾—åˆ°çš„æ˜¯ 404 code, æ³¨æ„æ­¤æ—¶é»˜è®¤ç”¨æˆ·åä¸º <code>user</code>, å¯†ç ä¼šåœ¨ç¨‹åºè¿è¡Œä¸­æ–­è¾“å‡º, å¯ä»¥å°è¯•ä¸€ä¸‹, å…·ä½“æ‹¦æˆªè¿‡ç¨‹å¦‚ä¸‹, å¯è§ä¸»è¦æ˜¯ <code>SecurityFilterChain</code> ç±»çš„ä½œç”¨,</p>
<p>This section examines how form-based login works within Spring Security. First, we see how the user is redirected to the login form:</p>
<p><img src="/005-spring-security/7.png" alt="7"></p>
<p>The preceding figure builds off our <a href="https://docs.spring.io/spring-security/reference/servlet/architecture.html#servlet-securityfilterchain"><code>SecurityFilterChain</code></a> diagram:</p>
<ol>
<li>First, a user makes an unauthenticated request to the resource (<code>/private</code>) for which it is not authorized.</li>
<li>Spring Securityâ€™s <a href="https://docs.spring.io/spring-security/reference/servlet/authorization/authorize-http-requests.html"><code>AuthorizationFilter</code></a> indicates that the unauthenticated request is <em>Denied</em> by throwing an <code>AccessDeniedException</code>.</li>
<li>Since the user is not authenticated, <a href="https://docs.spring.io/spring-security/reference/servlet/architecture.html#servlet-exceptiontranslationfilter"><code>ExceptionTranslationFilter</code></a> initiates <em>Start Authentication</em> and sends a redirect to the login page with the configured <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html#servlet-authentication-authenticationentrypoint"><code>AuthenticationEntryPoint</code></a>. In most cases, the <code>AuthenticationEntryPoint</code> is an instance of <a href="https://docs.spring.io/spring-security/site/docs/6.1.2/api/org/springframework/security/web/authentication/LoginUrlAuthenticationEntryPoint.html"><code>LoginUrlAuthenticationEntryPoint</code></a>.</li>
<li>The browser requests the login page to which it was redirected.</li>
<li>Something within the application, must <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/form.html#servlet-authentication-form-custom">render the login page</a>.</li>
</ol>
<p>è¿‡ç¨‹å¯å‚è€ƒ: <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/form.html">Form Login :: Spring Security</a></p>
<h2 id="3-è‡ªå®šä¹‰-spring-security---websecurityconfig-ç±»">3. è‡ªå®šä¹‰ spring security - <code>WebSecurityConfig</code> ç±»</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»ç”¨æ¥ä¿®æ”¹ spring security çš„é»˜è®¤é…ç½®, å³æŒ‡å®š spring security çš„è¡Œä¸º, æ¯”å¦‚æŒ‡å®šè®¿é—®å“ªä¸ªpageéœ€è¦è®¤è¯æ‰è¡Œ, æ”¯æŒä»€ä¹ˆæ–¹å¼ç™»å½•, å¦‚ form ç™»å½•, è°·æ­Œç™»å½•,  ä»¥åŠç™»å‡ºè¡Œä¸ºå’Œè·å–ç”¨æˆ·ä¿¡æ¯(æˆ‘ä»¬ç™»å½•éœ€è¦æ¯”å¯¹ç”¨æˆ·ä¿¡æ¯å§, å¯†ç æ˜¯å¦åŒ¹é…ç­‰), æˆ‘æŠŠè¿™ä¸ªç±»å‘½åä¸º <code>WebSecurityConfig.java</code>, è¿™ä¹Ÿæ˜¯ç¬¬äºŒä¸ªé‡è¦çš„ç±», ç¬¬ä¸€ä¸ªæ˜¯ç¬¬ä¸€èŠ‚æˆ‘ä»¬è®²åˆ°çš„ Controller,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@EnableWebSecurity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSecurityConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">securityFilterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// authorizeHttpRequests(): Allows restricting access based upon the HttpServletRequest using RequestMatcher implementations (i.e. via URL patterns).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">authorizeHttp</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="c1">// Method authenticated(): Specify that URLs are allowed by any authenticated user.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">authorizeHttp</span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="s">&#34;/private&#34;</span><span class="p">).</span><span class="na">authenticated</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="c1">// exempt all http request from authentication except for &#34;/private&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">authorizeHttp</span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">permitAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Enable form login, if I need login, show me a form</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// without this, when you access page that needs authentication will get Whitelabel Error Page with code 403</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">formLogin</span><span class="p">(</span><span class="n">withDefaults</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// UserDetailsService, an interface, is used to retrieve user-related data.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// It is used to retrieve user-related data from a data source, such as a database or a file for authentication and authorization purposes.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// e.g., It has one method named loadUserByUsername() which can be overridden to customize the process of finding the user.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// It is used by the DaoAuthenticationProvider to load details about the user during authentication.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDetailsService</span><span class="w"> </span><span class="nf">userDetailsService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// We are using in memory user password for demo purpose</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryUserDetailsManager</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">User</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">username</span><span class="p">(</span><span class="s">&#34;david&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// The {noop} prefix is a marker indicates that the password should be treated as plain text.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">password</span><span class="p">(</span><span class="s">&#34;{noop}asd&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">authorities</span><span class="p">(</span><span class="s">&#34;ROLE_user&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶è®¿é—® http://localhost:8080/private , æˆ‘ä»¬ä¼šè¢«è‡ªåŠ¨è½¬åˆ°ç™»å½•é¡µé¢, è´¦å·å¯†ç ä¸å†æ˜¯ä¸Šé¢é‚£èŠ‚ç”±springè‡ªåŠ¨ç”Ÿæˆ, è€Œæ˜¯æˆ‘ä»¬è‡ªå·±åˆ¶å®šçš„, å¯ä»¥çœ‹ä»£ç ä¸­çš„æ³¨é‡Š, æ³¨æ„æ­¤æ—¶æˆ‘ä»¬ç”¨çš„ <code>InMemoryUserDetailsManager</code> ä¸€èˆ¬æ˜¯ä½œä¸ºdemoæ¥å±•ç¤º, å³åˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶ç”¨æˆ·ç”¨äº form ç™»å½•, å®é™…å¼€å‘ è¦ä»æ•°æ®åº“æˆ–æ–‡ä»¶ä¸­è·å–ç”¨æˆ·çš„å¯†ç ä¿¡æ¯æ¥æ¯”å¯¹, å…·ä½“æ–¹æ³•ä¹‹åä¼šè®²,</p>
<p>å¦‚æœæ­¤æ—¶ä½ æŒ‰ç…§ç¬¬äºŒèŠ‚æˆ‘ä»¬æ‰€åšçš„å»å°è¯•è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢, http://localhost:8080/foo ä¼šå¾—åˆ° Whitelabel Error Page with code 403, ä½ å¯ä»¥å°è¯•ä¸€ä¸‹, çœ‹çœ‹, è¿™å°±å’Œç¬¬äºŒèŠ‚æˆ‘ä»¬å¾—åˆ°çš„ç»“æœä¸åŒ, åœ¨ç¬¬äºŒèŠ‚ä¸­æˆ‘ä»¬ä¼šè¢«è·³è½¬åˆ°ç™»å½•é¡µé¢, è¿™æ˜¯å› ä¸ºä»€ä¹ˆå‘¢? ä¸ºä»€ä¹ˆç»“æœä¼šä¸ç›¸åŒ?</p>
<p>è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ spring security çš„è®¾è®¡å“²å­¦æ˜¯ secure by default, å³åœ¨ç¬¬äºŒèŠ‚ä¸­æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹ä»»ä½• spring securityçš„è¡Œä¸º, åªæ˜¯æ·»åŠ äº†ä¾èµ–, æ‰€ä»¥æ­¤æ—¶è®¿é—®æ‰€æœ‰çš„é¡µé¢éƒ½éœ€è¦ç™»å½•, å³ä½¿æ˜¯ä¸ªä¸å­˜åœ¨çš„é¡µé¢, ä½†æ˜¯åœ¨è¿™èŠ‚æˆ‘ä»¬ä¿®æ”¹äº† spring securityçš„è¡Œä¸º, ä»”ç»†çœ‹ä¸Šé¢å…³äºæ§åˆ¶å“ªäº›endpointä¸éœ€è¦è®¤è¯ä¾¿å¯è®¿é—®çš„ä»£ç ä½ ä¼šå‘ç°æˆ‘ä»¬å¹¶æ²¡æœ‰éµå®ˆè¿™ä¸ªåŸåˆ™, æˆ‘ä»¬æ­£åœ¨åšçš„æ˜¯ expose everything, and secure some specific endpoints, è¿™æ˜¯ä¸å¯¹çš„, æˆ‘ä»¬è¦åè¿‡æ¥å†™, æ”¹æˆ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">securityFilterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">authorizeHttpRequests</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">authorizeHttp</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">authorizeHttp</span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">authorizeHttp</span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="s">&#34;/error&#34;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">authorizeHttp</span><span class="p">.</span><span class="na">requestMatchers</span><span class="p">(</span><span class="s">&#34;/favicon.ico&#34;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="c1">// Method authenticated(): Specify that URLs are allowed by any authenticated user.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">authorizeHttp</span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Enable form login, if I need login, show me a form</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// without this, when you access page that needs authentication will get Whitelabel Error Page with code 403</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">formLogin</span><span class="p">(</span><span class="n">withDefaults</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶æ‰æ˜¯ <em>secure by default:</em> <em>expose some specific endpoints, and secure everything</em>, ä½ å†è®¿é—® http://localhost:8080/foo , å°±ä¼šè·³è½¬åˆ°ç™»å½•é¡µé¢,</p>
<h2 id="4-single-sign-on-sso-å¯è·³è¿‡">4. Single sign-on (SSO) å¯è·³è¿‡</h2>
<p>Using SSO enables we can use open ID, æ¯”å¦‚å¹³æ—¶ç™»å½•æŒ‰é’®ä¸‹çš„ sign in with Google, è¿™ç§, å°±æ˜¯ä¾é çš„ Open ID, åœ¨ spring å®ç°è¿™ä¸ªå¾ˆç®€å•,</p>
<p>é¦–å…ˆéœ€è¦æ·»åŠ ä¾èµ–, ç¼–è¾‘ <code>build.gradle</code> dependencies éƒ¨åˆ†, æ·»åŠ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">implementation &#39;org.springframework.boot:spring-boot-starter-oauth2-client&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åç¬¬äºŒæ­¥å°±æ˜¯ enable oauth2-login, è¿˜è®°å¾—ä¸Šé¢é‚£èŠ‚é‡Œæˆ‘ä»¬å¦‚ä½•ä½¿èƒ½ form login çš„å—, ç±»ä¼¼åœ°, æˆ‘ä»¬åªç”¨åœ¨ä½¿èƒ½ form login çš„åœ°æ–¹æ·»åŠ ä¸€è¡Œä»£ç , to tell the <code>SecurityFilterChain</code> that we also want to be able to login in with oauth2 login,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">formLogin</span><span class="p">(</span><span class="n">withDefaults</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">oauth2Login</span><span class="p">(</span><span class="n">withDefaults</span><span class="p">())</span><span class="w"> </span><span class="c1">// æ–°åŠ çš„ä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// ...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸‰æ­¥å°±æ˜¯è¦åœ¨è°·æ­Œæ³¨å†Œç›¸å…³ä¿¡æ¯, å³æˆ‘ä»¬åœ¨ç”¨è°·æ­Œç™»å½•, ä¹Ÿç®—æ˜¯ç”¨äº†è°·æ­Œç›¸å…³çš„service, ä¸èƒ½è¯´ç›´æ¥ä¸ç»è¿‡è°·æ­Œç›¸å…³è®¤è¯å°±ç”¨äº†å§, æ­¤æ—¶æˆ‘ä»¬å…ˆæŠŠæ–‡ä»¶ <code>java/resources/application.properties</code> ä¿®æ”¹æˆ <code>application.yaml</code>, å†…å®¹ä¸º:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl">  security:
</span></span><span class="line"><span class="cl">    oauth2:
</span></span><span class="line"><span class="cl">      client:
</span></span><span class="line"><span class="cl">        registration:
</span></span><span class="line"><span class="cl">          google:
</span></span><span class="line"><span class="cl">            client-id:
</span></span><span class="line"><span class="cl">            client-secret:
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå‰©ä¸‹çš„å°±æ˜¯ä»è°·æ­Œè·å– client-id å’Œ client-secret, å…·ä½“é…ç½®å¯å‚è€ƒ: <a href="https://support.google.com/cloud/answer/6158849?hl=en">Setting up OAuth 2.0 - Google Cloud Platform Console Help</a></p>
<p><img src="/005-spring-security/2.png" alt="2"></p>
<p>ç„¶åç‚¹ create, å³å¯è·å¾— client-id å’Œ client-secret, ç„¶åå¡«å…¥ <code>application.yaml</code> ä¸­, è®°ä½å“¦, <strong>æäº¤è¿œç¨‹ä»“åº“çš„æ—¶å€™åˆ«å¿˜æŠŠè¿™ä¸ªæ–‡ä»¶åŠ å…¥åˆ° <code>.gitignore</code> ä¸­</strong>, ç„¶åè¿è¡Œç¨‹åºå°±å¯ä»¥å®ç°è°·æ­Œç™»å½•äº†,</p>
<blockquote>
<p><strong>OAuth</strong> (short for &ldquo;Open Authorization&rdquo;) is <strong>an open standard for access delegation</strong>, commonly used as a way for internet users to grant websites or applications access to their information on other websites but without giving them the passwords. <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a></p>
</blockquote>
<p>å¦å¤–æ³¨æ„è¿™ä¸ªæœåŠ¡éƒ½æ˜¯å…è´¹çš„, ä¸æ”¾å¿ƒçš„è¯å¯ä»¥åˆ° <a href="https://console.cloud.google.com/welcome/">https://console.cloud.google.com/welcome/</a> æŸ¥çœ‹ç®¡ç†ä½ çš„ project (çœ‹åˆ°æœ‰çš„ä¸€å¹´è®¢é˜…è´¹è¦15k, è¿™æ˜¯åœ¨è‡ªæˆ‘å®‰æ…°),</p>
<p><img src="/005-spring-security/4.png" alt="4"></p>
<p><img src="/005-spring-security/5.png" alt="5"></p>
<p><img src="/005-spring-security/6.png" alt="6"></p>
<h2 id="5-è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯---authentication-object">5. è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ - <code>Authentication Object</code></h2>
<p>è¿™é‡Œå°±è¦æåˆ°ä¸€ä¸ªé‡è¦çš„å¯¹è±¡, å³ Authentication Object, å®ƒä»£è¡¨ <strong>either the request to login or the result of a successful login request</strong> ,</p>
<ul>
<li>Authentication: represents the user. Contains:
<ul>
<li>ï»¿ï»¿Principal: user &ldquo;identity&rdquo; (name, email&hellip;)</li>
<li>ï»¿ï»¿GrantedAuthorities: &ldquo;permissions&rdquo; (roles,..)</li>
<li>isAuthenticated(): almost always true, å¦‚æœä¸æ˜¯ true, é‚£è¿™ä¸ª request åŸºæœ¬ä¼šè¢« blocked, é‚£æˆ‘ä»¬ä¹Ÿæ— æ³•è·å¾—è¿™ä¸ª Authentication äº†, å› ä¸º SecurityFilterChain çš„è¿™ä¸ªä»£ç : <code>authorizeHttp.anyRequest().authenticated()</code>, å³é™¤äº†é‚£å‡ ä¸ª endpoints çš„è¯·æ±‚ä¸éœ€è¦è®¤è¯, å…¶ä»–çš„éƒ½éœ€è¦ authenticated,</li>
<li>ï»¿ï»¿details: details about the request</li>
<li>ï»¿ï»¿(Credentials): &ldquo;password&rdquo;, often null</li>
</ul>
</li>
</ul>
<p>äº†è§£æ›´å¤šå…³äº Authentication: <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">Servlet Authentication Architecture :: Spring Security</a></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ Authentication object æ¥è·å–ç”¨æˆ·åå¯†ç ç­‰ä¿¡æ¯, è¿™ä¹Ÿæ˜¯ç¬¬ä¸‰ä¸ªé‡è¦çš„ç±», åªä¸è¿‡è¿™ä¸ªç±»ä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„, è€Œæ˜¯ spring å¹³å°çš„, äº†è§£æ›´å¤š: <a href="https://docs.spring.io/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html">Authentication (Spring Security 3.0.8.RELEASE API) </a></p>
<blockquote>
<p>Authentication Object: Represents the token for an authentication request or for an authenticated principal once the request has been processed by the <a href="https://docs.spring.io/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationManager.html#authenticate(org.springframework.security.core.Authentication)"><code>AuthenticationManager.authenticate(Authentication)</code></a> method. Once the request has been authenticated, the <code>Authentication</code> will usually be stored in a thread-local <code>SecurityContext</code> managed by the <a href="https://docs.spring.io/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/context/SecurityContextHolder.html"><code>SecurityContextHolder</code></a> by the authentication mechanism which is being used. In Spring Security, the term &ldquo;authenticated principal&rdquo; refers to the authenticated user or entity. It represents the currently logged-in user or entity who has successfully completed the authentication process. In most cases, <strong>the framework transparently takes care of managing the security context and authentication objects for you.</strong> <a href="https://docs.spring.io/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html">Authentication</a></p>
</blockquote>
<blockquote>
<p>æ³¨æ„, authentication object å°±åœ¨ <code>SecurityContext</code>, å®ƒæ˜¯ thread-local, æ‰€ä»¥æ¯”å¦‚ä½ çš„æœåŠ¡å™¨ tomcat æœ‰100ä¸ªçº¿ç¨‹æ¥å¤„ç† request, æ¯ä¸ªçº¿ç¨‹å†…çš„ <code>SecurityContext</code>éƒ½ä¸ä¸€æ ·, è€Œä¸”  <code>SecurityContext</code> global static, é™¤æ­¤ä¹‹å¤–, when a request comes in, runs on a thread, and when it&rsquo;s done, some other request is going to use this thread, and the <code>SecurityContext</code> will be clean before this,</p>
<p>æ‰€ä»¥ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è·å–å®ƒ, å³å¦‚æœæœ‰æ—¶å€™ä½ æœ‰ä¸ª Controller, ç„¶åæœ‰å››äº”ä¸ªæ–¹æ³• nested, ä¸ç”¨åƒä¸‹é¢é‚£æ ·é€šè¿‡å‚æ•° inject authentication object, å¤ªéº»çƒ¦äº†, å¯ä»¥ç›´æ¥è·å¾—,</p>
<p><code>var authentication = SecurityContextHolder.getContext().getAuthentication();</code></p>
<p><a href="https://youtu.be/iJ2muJniikY?t=2085">https://youtu.be/iJ2muJniikY?t=2085</a></p>
</blockquote>
<p><img src="/005-spring-security/a.png" alt="a"></p>
<p>çœ‹çœ‹ authentication å¯¹è±¡çš„æ–¹æ³•:</p>
<ul>
<li><code>getPrincipal()</code>
<ul>
<li>The identity of the principal being authenticated. In the case of an authentication request with username and password, this would be the username.</li>
</ul>
</li>
<li><code>getCredentials()</code>
<ul>
<li>The credentials that prove the principal is correct. This is usually a password, but could be anything relevant to the <code>AuthenticationManager</code>.</li>
<li>ä¸€ä¸ªCredentialsè¾“å‡º: <code>org.springframework.security.core.userdetails.User [Username=david, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, credentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_user]]</code></li>
</ul>
</li>
</ul>
<p>ä¿®æ”¹å‰é¢å®šä¹‰çš„ Controller, inject Authentication object to the <code>/private</code> endpoint,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">publicPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Hello David~&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/private&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">privatePage</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Hi ~[&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;]~, you&#39;ve logged in. ğŸ‰&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åè¿è¡Œé¡¹ç›®, ç™»å½•åå¾—åˆ°è¾“å‡º:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Hi ~[david]~, you&#39;ve logged in. ğŸ‰
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-æŸ¥çœ‹-openid-ç”¨æˆ·é‚®ç®±">6. æŸ¥çœ‹ OpenID ç”¨æˆ·é‚®ç®±</h2>
<p>ä¿®æ”¹ Controller ä»£ç , æ–°åŠ ä¸€ä¸ªè‡ªå®šä¹‰æ–¹æ³•, getName()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">publicPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Hello David~&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/private&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">privatePage</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Hi ~[&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">getName</span><span class="p">(</span><span class="n">authentication</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;]~, you&#39;ve logged in. ğŸ‰&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getName</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">OidcUser</span><span class="p">.</span><span class="na">class</span><span class="p">::</span><span class="n">isInstance</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">OidcUser</span><span class="p">.</span><span class="na">class</span><span class="p">::</span><span class="n">cast</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">OidcUser</span><span class="p">::</span><span class="n">getEmail</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">orElseGet</span><span class="p">(</span><span class="n">authentication</span><span class="p">::</span><span class="n">getName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œåé€‰æ‹©è°·æ­Œç™»å½•, è¾“å‡º: Hi ~[shehu@gmail.com]~, you&rsquo;ve logged in. ğŸ‰</p>
<h2 id="7-é€šè¿‡-debug-æŸ¥çœ‹-authentication-object">7. é€šè¿‡ debug æŸ¥çœ‹ <code>Authentication Object</code></h2>
<p>è®¾ç½®æ–­ç‚¹,</p>
<p><img src="/005-spring-security/8.png" alt="8"></p>
<p>è®¿é—® <code>/private</code> é¡µé¢è¾“å…¥å¯†ç ç™»å½•, è¿”å› IDE,</p>
<p><img src="/005-spring-security/9.png" alt="9"></p>
<p>ä¸‹é¢æ˜¯é€šè¿‡ ouath Google ç™»å½•ä¹‹åçš„ Authentication ä¿¡æ¯,</p>
<p><img src="/005-spring-security/10.png" alt="10"></p>
<h2 id="8-æ€»ç»“">8. æ€»ç»“</h2>
<p>æ€»ç»“å¤§æ¦‚ä» 25:00 å·¦å³å¼€å§‹,</p>
<p>{% youtube iJ2muJniikY %}</p>
<p>æœ¬æ–‡ä¸»è¦å‚è€ƒ: <a href="https://youtu.be/iJ2muJniikY">https://youtu.be/iJ2muJniikY</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">David</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-08-04
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">Java</a>
          <a href="/tags/spring-boot/">Spring Boot</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/java/basics/000-array/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Java Array</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/java/backend/004-thymeleaf/">
            <span class="next-text nav-default">Thymeleaf, Springå­¦ä¹ (å››)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:shwezhu@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/shwezhu" class="iconfont icon-github" title="github"></a>
  <a href="https://davidzhu.xyz/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2023 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span><span>David</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
